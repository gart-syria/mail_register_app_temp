[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-03 07:42:31.235148",
  "module": "Mail Register App",
  "name": "Auto Mail Number",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Mail Register",
  "script": "# Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø§Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ø±Ø¯ Ø£Ùˆ ØµØ§Ø¯Ø±\n\nyear = frappe.utils.nowdate().split('-')[0]\n\n# ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±ÙŠØ¯\ndirection = \"OUT\" if doc.mail_type == \"Outgoing\" else \"IN\"\n\n# ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ Ø³ÙŠÙØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±ÙŠØ¯\nif direction == \"OUT\":\n    if not doc.issuing_office:\n        frappe.throw(\"Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø© (Issuing Office) Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.\")\n    diwan_office = doc.issuing_office\nelse:  # Incoming\n    if not doc.receiver_office:\n        frappe.throw(\"Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø© (Receiver Office) Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.\")\n    diwan_office = doc.receiver_office\n\n# Ø¬Ù„Ø¨ Ø±Ù…Ø² Ø§Ù„Ø¯ÙŠÙˆØ§Ù†\ndiwan_doc = frappe.get_doc(\"Diwan\", diwan_office)\ndiwan_code = diwan_doc.code or \"UNK\"\n\n# Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø£Ø³Ù…Ø§Ø¡\npattern = f\"{diwan_code}-{direction}-{year}-%\"\n\n# Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù†Ù…Ø· Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©\nexisting = frappe.db.get_all(\n    \"Mail Register\",\n    filters={\n        \"name\": [\"like\", pattern],\n        \"docstatus\": [\"!=\", 2]\n    },\n    fields=[\"name\"]\n)\n\n# ØªØ­Ø¯ÙŠØ¯ Ø£ÙƒØ¨Ø± Ø±Ù‚Ù… Ù…Ø³ØªØ®Ø¯Ù…\nmax_num = 0\nfor e in existing:\n    try:\n        num = int(e[\"name\"].split(\"-\")[-1])\n        if num > max_num:\n            max_num = num\n    except:\n        pass\n\n# ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ Ø£ÙƒØ¨Ø± Ø±Ù‚Ù…\nnext_num = max_num + 1\nnew_name = f\"{diwan_code}-{direction}-{year}-{str(next_num).zfill(5)}\"\n\n# ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯\ndoc.name = new_name\ndoc.mail_number = new_name\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-17 10:43:45.931168",
  "module": "Mail Register App",
  "name": "get_user_diwan",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "import frappe\n\n@frappe.whitelist()\ndef get_user_diwan(user=None):\n    \"\"\"Return user's Diwan based on User Diwan Mapping.\"\"\"\n    user = user or frappe.session.user\n    diwan = frappe.db.get_value(\n        \"User Diwan Mapping\",\n        {\"user\": user},\n        \"diwan\"\n    )\n    return diwan\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-11 10:41:40.488648",
  "module": "Mail Register App",
  "name": "Filter mails according to user",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Mail Register",
  "script": "# Check System Manager role using DB (safe_exec compatible)\nis_system_manager = frappe.db.exists(\n    \"Has Role\",\n    {\n        \"parent\": user,\n        \"role\": \"System Manager\"\n    }\n)\n\nif is_system_manager:\n    conditions = \"1=1\"\nelse:\n    diwan = frappe.db.get_value(\n        \"User Diwan Mapping\",\n        {\"user\": user},\n        \"diwan\"\n    )\n\n    if not diwan:\n        conditions = \"1=0\"\n    else:\n        conditions = f\"\"\"\n        (\n            (\n                `tabMail Register`.`mail_type` = 'Outgoing'\n                AND `tabMail Register`.`issuing_office` = '{diwan}'\n            )\n            OR\n            (\n                `tabMail Register`.`mail_type` = 'Incoming'\n                AND `tabMail Register`.`receiver_office` = '{diwan}'\n            )\n        )\n        \"\"\"\n",
  "script_type": "Permission Query"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-11 10:21:46.516748",
  "module": "Mail Register App",
  "name": "Auto Fill Mail Reciepient in Queue",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Mail Register",
  "script": "doc = frappe.get_doc(\"Mail Register\", doc.name)\n\nif doc.mail_type == \"Outgoing\":\n\n    for r in doc.recipients:\n        if r.status != \"Sent\":\n            continue\n\n        exists = frappe.db.exists(\n            \"Incoming Confirmation Queue\",\n            {\n                \"mail_recipient_row\": r.name\n            }\n        )\n\n        if exists:\n            continue\n\n        queue = frappe.new_doc(\"Incoming Confirmation Queue\")\n        queue.mail_register = doc.name\n        queue.mail_recipient_row = r.name\n        queue.recipient_office = r.recipient_office\n        queue.status = r.status\n\n        queue.mail_number = doc.mail_number\n        queue.mail_date = doc.mail_date\n        queue.subject = doc.subject\n\n        queue.received_confirmed = 0\n\n        queue.insert(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-11 11:08:06.572383",
  "module": "Mail Register App",
  "name": "Filter Waiting Mails Acording to User",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Incoming Confirmation Queue",
  "script": "user = frappe.session.user\n\n# System Manager ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡\nis_system_manager = frappe.db.exists(\n    \"Has Role\",\n    {\n        \"parent\": user,\n        \"role\": \"System Manager\"\n    }\n)\n\nif is_system_manager:\n    conditions = \"1=1\"\nelse:\n    # Ø¬Ù„Ø¨ Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n    diwan = frappe.db.get_value(\n        \"User Diwan Mapping\",\n        {\"user\": user},\n        \"diwan\"\n    )\n\n    if not diwan:\n        conditions = \"1=0\"\n    else:\n        conditions = (\n            \"`tabIncoming Confirmation Queue`.`recipient_office` = \"\n            f\"'{diwan}'\"\n        )\n",
  "script_type": "Permission Query"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-14 11:04:03.261661",
  "module": "Mail Register App",
  "name": "Add Notes to Mail Reciepient Doctype with Ability to Update and Tracking",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Mail Annotation",
  "script": "annotation = doc\n\nincoming = frappe.get_doc(\"Mail Register\", annotation.mail_register)\n\nif incoming.linked_outgoing_mail:\n\n    outgoing = frappe.get_doc(\n        \"Mail Register\",\n        incoming.linked_outgoing_mail\n    )\n\n    for r in outgoing.recipients:\n        if r.recipient_office == incoming.receiver_office:\n            # Ø±Ø¨Ø· Ù…Ù†Ø·Ù‚ÙŠ Ø¯Ø§Ø¦Ù…\n            annotation.recipient_office = r.recipient_office\n            r.notes = annotation.annotation_text\n            break\n\n    annotation.db_update()\n    outgoing.save(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-20 10:57:38.420804",
  "module": "Mail Register App",
  "name": "Track Updating of Notes",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Mail Annotation",
  "script": "old = doc.get_doc_before_save()\n\nif old and old.annotation_text != doc.annotation_text:\n\n    # Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ®\n    frappe.get_doc({\n        \"doctype\": \"Mail Annotation History\",\n        \"parent_annotation\": doc.name,\n        \"old_annotation_text\": old.annotation_text,\n        \"modified_by\": frappe.session.user,\n        \"modified_on\": frappe.utils.now(),\n        \"version\": old.version or 1\n    }).insert(ignore_permissions=True)\n\n    doc.version = (old.version or 1) + 1\n    doc.is_current = 1\n\n    incoming = frappe.get_doc(\"Mail Register\", doc.mail_register)\n\n    if incoming.linked_outgoing_mail:\n\n        outgoing = frappe.get_doc(\n            \"Mail Register\",\n            incoming.linked_outgoing_mail\n        )\n\n        for r in outgoing.recipients:\n            if r.recipient_office == doc.recipient_office:\n                r.notes = doc.annotation_text\n                break\n\n        outgoing.save(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-17 09:40:02.817118",
  "module": "Mail Register App",
  "name": "Set root Outgoing Mail",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Mail Register",
  "script": "# ===============================\n# Set Root Outgoing Mail\n# ===============================\n\n# Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø°Ø± Ù…Ù…Ù„ÙˆØ¡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ø§ Ù†ØºÙŠØ±Ù‡\nif doc.root_outgoing_mail:\n    pass\n\n# ğŸ“¤ ØµØ§Ø¯Ø± Ø¬Ø¯ÙŠØ¯ (Ù„ÙŠØ³ Ø±Ø¯)\nelif doc.mail_type == \"Outgoing\" and not doc.reply_to:\n    doc.root_outgoing_mail = doc.name\n\n# ğŸ“¤ ØµØ§Ø¯Ø± Ø±Ø¯ (ÙŠØ±Ø« Ø§Ù„Ø¬Ø°Ø± Ù…Ù† Ø§Ù„Ø£ØµÙ„)\nelif doc.mail_type == \"Outgoing\" and doc.reply_to:\n    parent = frappe.get_doc(\"Mail Register\", doc.reply_to)\n\n    if parent.root_outgoing_mail:\n        doc.root_outgoing_mail = parent.root_outgoing_mail\n    else:\n        doc.root_outgoing_mail = parent.name\n\n# ğŸ“¥ ÙˆØ§Ø±Ø¯ Ù…ÙÙ†Ø´Ø£ Ù…Ù† ØµØ§Ø¯Ø±\nelif doc.mail_type == \"Incoming\" and doc.linked_outgoing_mail:\n    outgoing = frappe.get_doc(\"Mail Register\", doc.linked_outgoing_mail)\n\n    # Ø¥Ù† ÙƒØ§Ù† Ø§Ù„ØµØ§Ø¯Ø± Ø§Ù„Ø£ØµÙ„ÙŠ\n    if outgoing.root_outgoing_mail:\n        doc.root_outgoing_mail = outgoing.root_outgoing_mail\n    else:\n        doc.root_outgoing_mail = outgoing.name\n",
  "script_type": "DocType Event"
 }
]